<!doctype html>
<html>
<head>
    <title>Process Refund - RMA {{ rma.rma_number or ('#' ~ rma.id) }}</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; }
        .header { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .status { padding: 6px 12px; border-radius: 4px; font-size: 14px; font-weight: bold; display: inline-block; }
        .status-DISPOSITION { background: #fff3cd; color: #856404; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: white; }
        .section h2 { margin-top: 0; color: #333; border-bottom: 2px solid #28a745; padding-bottom: 10px; }
        .info-row { display: flex; padding: 8px 0; border-bottom: 1px solid #eee; }
        .info-label { font-weight: bold; width: 180px; color: #666; }
        .info-value { flex: 1; color: #333; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;
        }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .amount-display { font-size: 24px; font-weight: bold; color: #28a745; padding: 15px; background: #e8f5e9; border-radius: 8px; text-align: center; }
        .btn-submit { background: #28a745; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-submit:hover { background: #218838; }
        .btn-cancel { background: #6c757d; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; text-decoration: none; display: inline-block; }
        .btn-cancel:hover { background: #5a6268; }
        .back-link { display: inline-block; margin: 15px 0; color: #1976d2; text-decoration: none; }
        .back-link:hover { text-decoration: underline; }
        .note { background: #fff3cd; padding: 12px; border-left: 4px solid #ffc107; margin: 15px 0; font-size: 14px; }
    </style>
</head>
<body>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div style="margin: 20px 0;">
        {% for category, message in messages %}
          <div style="padding: 12px; border-radius: 4px; margin-bottom: 10px; {% if category == 'error' %}background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;{% else %}background: #d4edda; color: #155724; border: 1px solid #c3e6cb;{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    
    <div class="header">
        <h1>Process Refund</h1>
        <div>RMA: <strong>{{ rma.rma_number or ('#' ~ rma.id) }}</strong></div>
        <p>Status: <span class="status status-{{ rma.status }}">{{ rma.status }}</span></p>
    </div>
    
    <div class="section">
        <h2>Refund Information</h2>
        <div class="info-row">
            <div class="info-label">Customer ID:</div>
            <div class="info-value">{{ rma.user_id }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Order ID:</div>
            <div class="info-value">#{{ rma.sale_id }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Disposition:</div>
            <div class="info-value"><strong>{{ rma.disposition }}</strong></div>
        </div>
        <div class="info-row">
            <div class="info-label">Disposition Reason:</div>
            <div class="info-value">{{ rma.disposition_reason or 'N/A' }}</div>
        </div>
    </div>

    <div class="section">
        <h2>Refund Amount</h2>
        <div class="amount-display">
            ${{ "%.2f"|format(requested_amount) }}
        </div>
        <p style="color: #666; font-size: 14px; margin: 10px 0;">Calculated from returned items at purchase price.</p>
    </div>
    
    <div class="section">
        <h2>Process Refund</h2>
        
        <form method="POST" action="/rma/admin/{{ rma.id }}/process-refund">
            <div class="form-group">
                <label for="method">Refund Method *</label>
                <select id="method" name="method" required>
                    <option value="">-- Select Method --</option>
                    <option value="ORIGINAL_PAYMENT">Refund to Original Payment Method</option>
                    <option value="STORE_CREDIT">Issue Store Credit</option>
                    <option value="CHECK">Mail Check</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="amount_dollars">Refund Amount (USD) *</label>
                <input type="number" id="amount_dollars" name="amount_dollars" 
                       step="0.01" min="0" 
                       value="{{ "%.2f"|format(requested_amount) }}" 
                       required>
                <small style="color:#666;">Adjust if needed (e.g., partial refund, restocking fee)</small>
            </div>
            
            <div class="form-group">
                <label for="notes">Processing Notes</label>
                <textarea id="notes" name="notes" placeholder="Optional notes about this refund..."></textarea>
            </div>
            
            <div style="margin-top: 20px;">
                <button type="submit" class="btn-submit">✓ Process Refund</button>
                <a href="/rma/admin/processing-queue" class="btn-cancel">Cancel</a>
            </div>
        </form>
    </div>
    
    <a href="/rma/admin/processing-queue" class="back-link">← Back to Processing Queue</a>
</body>
</html>
